<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/utils/webvtt-parser.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/utils</a> webvtt-parser.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.87% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>7/89</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/45</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">7.87% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>7/89</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import VTTParser from './vttparser';
&nbsp;
// String.prototype.startsWith is not supported in IE11
const <span class="fstat-no" title="function not covered" >startsWith = f</span>unction(inputString, searchString, position) {
<span class="cstat-no" title="statement not covered" >  return inputString.substr(position || 0, searchString.length) === searchString;</span>
};
&nbsp;
const <span class="fstat-no" title="function not covered" >cueString2millis = f</span>unction(timeString) {
    l</span>et ts = <span class="cstat-no" title="statement not covered" >parseInt(timeString.substr(-3));
    l</span>et secs = <span class="cstat-no" title="statement not covered" >parseInt(timeString.substr(-6,2));
    l</span>et mins = <span class="cstat-no" title="statement not covered" >parseInt(timeString.substr(-9,2));
    l</span>et hours = <span class="cstat-no" title="statement not covered" >timeString.length &gt; 9 ? parseInt(timeString.substr(0, timeString.indexOf(':'))) : 0;
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (isNaN(ts) || isNaN(secs) || isNaN(mins) || isNaN(hours)) {</span>
<span class="cstat-no" title="statement not covered" >        return -1;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    ts += 1000 * secs;</span>
<span class="cstat-no" title="statement not covered" >    ts += 60*1000 * mins;</span>
<span class="cstat-no" title="statement not covered" >    ts += 60*60*1000 * hours;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return ts;</span>
};
&nbsp;
// From https://github.com/darkskyapp/string-hash
const hash = <span class="fstat-no" title="function not covered" >function(</span>text) {
    l</span>et hash = <span class="cstat-no" title="statement not covered" >5381;
    l</span>et i = <span class="cstat-no" title="statement not covered" >text.length;
<span class="cstat-no" title="statement not covered" >    while (i) {</span>
<span class="cstat-no" title="statement not covered" >        hash = (hash * 33) ^ text.charCodeAt(--i);</span>
    }
<span class="cstat-no" title="statement not covered" >    return (hash &gt;&gt;&gt; 0).toString();</span>
};
&nbsp;
const <span class="fstat-no" title="function not covered" >calculateOffset = f</span>unction(vttCCs, cc, presentationTime) {
    l</span>et currCC = <span class="cstat-no" title="statement not covered" >vttCCs[cc];
    l</span>et prevCC = <span class="cstat-no" title="statement not covered" >vttCCs[currCC.prevCC];
&nbsp;
    // This is the first discontinuity or cues have been processed since the last discontinuity
    // Offset = current discontinuity time
<span class="cstat-no" title="statement not covered" >    if (!prevCC || (!prevCC.new &amp;&amp; currCC.new)) {</span>
<span class="cstat-no" title="statement not covered" >        vttCCs.ccOffset = vttCCs.presentationOffset = currCC.start;</span>
<span class="cstat-no" title="statement not covered" >        currCC.new = false;</span>
<span class="cstat-no" title="statement not covered" >        return;</span>
    }
&nbsp;
    // There have been discontinuities since cues were last parsed.
    // Offset = time elapsed
<span class="cstat-no" title="statement not covered" >    while (prevCC &amp;&amp; prevCC.new) {</span>
<span class="cstat-no" title="statement not covered" >        vttCCs.ccOffset += currCC.start - prevCC.start;</span>
<span class="cstat-no" title="statement not covered" >        currCC.new = false;</span>
<span class="cstat-no" title="statement not covered" >        currCC = prevCC;</span>
<span class="cstat-no" title="statement not covered" >        prevCC = vttCCs[currCC.prevCC];</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    vttCCs.presentationOffset = presentationTime;</span>
};
&nbsp;
const WebVTTParser = {
    parse: <span class="fstat-no" title="function not covered" >function(</span>vttByteArray, syncPTS, vttCCs, cc, callBack, errorCallBack) {
        // Convert byteArray into string, replacing any somewhat exotic linefeeds with "\n", then split on that character.
        l</span>et re = <span class="cstat-no" title="statement not covered" >/\r\n|\n\r|\n|\r/g;
        l</span>et vttLines = <span class="cstat-no" title="statement not covered" >String.fromCharCode.apply(null, new Uint8Array(vttByteArray)).trim().replace(re, '\n').split('\n');
        l</span>et cueTime = <span class="cstat-no" title="statement not covered" >'00:00.000';
        l</span>et mpegTs = <span class="cstat-no" title="statement not covered" >0;
        l</span>et localTime = <span class="cstat-no" title="statement not covered" >0;
        l</span>et presentationTime = <span class="cstat-no" title="statement not covered" >0;
        l</span>et cues = <span class="cstat-no" title="statement not covered" >[];
        l</span>et <span class="cstat-no" title="statement not covered" >parsingError;
        l</span>et inHeader = <span class="cstat-no" title="statement not covered" >true;
        // let VTTCue = VTTCue || window.TextTrackCue;
&nbsp;
        // Create parser object using VTTCue with TextTrackCue fallback on certain browsers.
        l</span>et parser = <span class="cstat-no" title="statement not covered" >new VTTParser();
&nbsp;
<span class="cstat-no" title="statement not covered" >        parser.oncue = <span class="fstat-no" title="function not covered" >function(</span>cue) {</span>
            // Adjust cue timing; clamp cues to start no earlier than - and drop cues that don't end after - 0 on timeline.
            l</span>et currCC = <span class="cstat-no" title="statement not covered" >vttCCs[cc];
            l</span>et cueOffset = <span class="cstat-no" title="statement not covered" >vttCCs.ccOffset;
&nbsp;
            // Update offsets for new discontinuities
<span class="cstat-no" title="statement not covered" >            if (currCC &amp;&amp; currCC.new) {</span>
<span class="cstat-no" title="statement not covered" >                if (localTime !== undefined) {</span>
                    // When local time is provided, offset = discontinuity start time - local time
<span class="cstat-no" title="statement not covered" >                    cueOffset = vttCCs.ccOffset = currCC.start;</span>
                } else {
<span class="cstat-no" title="statement not covered" >                    calculateOffset(vttCCs, cc, presentationTime);</span>
                }
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (presentationTime) {</span>
                // If we have MPEGTS, offset = presentation time + discontinuity offset
<span class="cstat-no" title="statement not covered" >                cueOffset = presentationTime + vttCCs.ccOffset - vttCCs.presentationOffset;</span>
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            cue.startTime += cueOffset - localTime;</span>
<span class="cstat-no" title="statement not covered" >            cue.endTime += cueOffset - localTime;</span>
&nbsp;
            // Create a unique hash id for a cue based on start/end times and text.
            // This helps timeline-controller to avoid showing repeated captions.
<span class="cstat-no" title="statement not covered" >            cue.id = hash(cue.startTime) + hash(cue.endTime) + hash(cue.text);</span>
&nbsp;
            // Fix encoding of special characters. TODO: Test with all sorts of weird characters.
<span class="cstat-no" title="statement not covered" >            cue.text = decodeURIComponent(escape(cue.text));</span>
<span class="cstat-no" title="statement not covered" >            if (cue.endTime &gt; 0) {</span>
<span class="cstat-no" title="statement not covered" >              cues.push(cue);</span>
            }
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        parser.onparsingerror = <span class="fstat-no" title="function not covered" >function(</span>e) {</span>
<span class="cstat-no" title="statement not covered" >            parsingError = e;</span>
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        parser.onflush = <span class="fstat-no" title="function not covered" >function() </span>{</span>
<span class="cstat-no" title="statement not covered" >            if (parsingError &amp;&amp; errorCallBack) {</span>
<span class="cstat-no" title="statement not covered" >                errorCallBack(parsingError);</span>
<span class="cstat-no" title="statement not covered" >                return;</span>
            }
<span class="cstat-no" title="statement not covered" >            callBack(cues);</span>
        };
&nbsp;
        // Go through contents line by line.
<span class="cstat-no" title="statement not covered" >        vttLines.forEach(<span class="fstat-no" title="function not covered" >line =&gt; </span>{</span>
<span class="cstat-no" title="statement not covered" >            if (inHeader) {</span>
                // Look for X-TIMESTAMP-MAP in header.
<span class="cstat-no" title="statement not covered" >                if (startsWith(line, 'X-TIMESTAMP-MAP=')) {</span>
                    // Once found, no more are allowed anyway, so stop searching.
<span class="cstat-no" title="statement not covered" >                    inHeader = false;</span>
                    // Extract LOCAL and MPEGTS.
<span class="cstat-no" title="statement not covered" >                    line.substr(16).split(',').forEach(<span class="fstat-no" title="function not covered" >timestamp =&gt; </span>{</span>
<span class="cstat-no" title="statement not covered" >                        if (startsWith(timestamp, 'LOCAL:')) {</span>
<span class="cstat-no" title="statement not covered" >                          cueTime = timestamp.substr(6);</span>
                        } else <span class="cstat-no" title="statement not covered" >if (startsWith(timestamp, 'MPEGTS:')) {</span>
<span class="cstat-no" title="statement not covered" >                          mpegTs = parseInt(timestamp.substr(7));</span>
                        }
                    });
<span class="cstat-no" title="statement not covered" >                    try {</span>
                        // Calculate subtitle offset in milliseconds.
                        // If sync PTS is less than zero, we have a 33-bit wraparound, which is fixed by adding 2^33 = 8589934592.
<span class="cstat-no" title="statement not covered" >                        syncPTS = syncPTS &lt; 0 ? syncPTS + 8589934592 : syncPTS;</span>
                        // Adjust MPEGTS by sync PTS.
<span class="cstat-no" title="statement not covered" >                        mpegTs -= syncPTS;</span>
                        // Convert cue time to seconds
<span class="cstat-no" title="statement not covered" >                        localTime = cueString2millis(cueTime) / 1000;</span>
                        // Convert MPEGTS to seconds from 90kHz.
<span class="cstat-no" title="statement not covered" >                        presentationTime = mpegTs / 90000;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                        if (localTime === -1) {</span>
<span class="cstat-no" title="statement not covered" >                            parsingError = new Error(`Malformed X-TIMESTAMP-MAP: ${line}`);</span>
                        }
                    }
                    catch(e) {
<span class="cstat-no" title="statement not covered" >                        parsingError = new Error(`Malformed X-TIMESTAMP-MAP: ${line}`);</span>
                    }
                    // Return without parsing X-TIMESTAMP-MAP line.
<span class="cstat-no" title="statement not covered" >                    return;</span>
                } else <span class="cstat-no" title="statement not covered" >if (line === '') {</span>
<span class="cstat-no" title="statement not covered" >                  inHeader = false;</span>
                }
            }
            // Parse line by default.
<span class="cstat-no" title="statement not covered" >            parser.parse(line+'\n');</span>
        });
&nbsp;
<span class="cstat-no" title="statement not covered" >        parser.flush();</span>
    }
};
&nbsp;
&nbsp;
module.exports = WebVTTParser;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Fri Jun 23 2017 22:48:12 GMT-0700 (PDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
